<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Engine</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">claro</span> <span class="project-version">0.2.20</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="00-basics.html"><div class="inner"><span>Basic Resolution</span></div></a></li><li class="depth-1 "><a href="01-projection.html"><div class="inner"><span>Projections</span></div></a></li><li class="depth-1 "><a href="02-advanced-projection.html"><div class="inner"><span>Advanced Projections</span></div></a></li><li class="depth-1  current"><a href="03-engine.html"><div class="inner"><span>Engine</span></div></a></li><li class="depth-1 "><a href="04-testing-and-debugging.html"><div class="inner"><span>Testing &amp; Debugging</span></div></a></li><li class="depth-1 "><a href="99-notes.html"><div class="inner"><span>Implementation Notes</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>claro</span></div></div></li><li class="depth-2"><a href="claro.data.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>data</span></div></a></li><li class="depth-3"><a href="claro.data.ops.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ops</span></div></a></li><li class="depth-2"><a href="claro.engine.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>engine</span></div></a></li><li class="depth-3 branch"><a href="claro.engine.adapter.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adapter</span></div></a></li><li class="depth-3"><a href="claro.engine.selector.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>selector</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>middleware</span></div></div></li><li class="depth-3 branch"><a href="claro.middleware.cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cache</span></div></a></li><li class="depth-3 branch"><a href="claro.middleware.deferred.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>deferred</span></div></a></li><li class="depth-3 branch"><a href="claro.middleware.intercept.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>intercept</span></div></a></li><li class="depth-3 branch"><a href="claro.middleware.mock.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mock</span></div></a></li><li class="depth-3 branch"><a href="claro.middleware.observe.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>observe</span></div></a></li><li class="depth-3"><a href="claro.middleware.transform.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>transform</span></div></a></li><li class="depth-2"><a href="claro.projection.html"><div class="inner"><span class="tree" style="top: -207px;"><span class="top" style="height: 216px;"></span><span class="bottom"></span></span><span>projection</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#engine" name="engine"></a>Engine</h1>
<p>So far, we’ve only used <code>claro.engine/run!!</code> to resolve our values. But claro’s engine offers a lot more.</p>
<p>First off, both <a href="claro.engine.html#var-run.21.21">run!!</a> and <a href="claro.engine.html#var-run.21">run!</a> use the default engine but you can build a custom one using <a href="claro.engine.html#var-engine">claro.engine/engine</a>. Engines implement <code>IFn</code>, so they can be called like functions.</p>
<pre><code class="clojure">(defonce run-engine
  (engine/engine ...))

@(run-engine (-&gt;Person 1))
</code></pre>
<p>The next sections describe the moving/customizable parts.</p>
<h3><a href="#deferred-values" name="deferred-values"></a>Deferred Values</h3>
<p>Instead of blocking during resolution, <a href="claro.engine.html#var-run.21">run!</a> produces a deferred value:</p>
<pre><code class="clojure">(engine/run! (-&gt;Person 1))
;; =&gt; &lt;&lt; … &gt;&gt;
</code></pre>
<p>The default implementation uses <a href="https://github.com/ztellman/manifold">Manifold</a>, so you can set execution timeouts or register error handlers:</p>
<pre><code class="clojure">(-&gt; (-&gt;Person 1)
    (engine/run!)
    (d/catch
      (fn [_]
        ::error))
    (d/timeout! 1000 ::timeout))
</code></pre>
<p>To use a different implementation (e.g. the one provided in <code>claro.runtime.impl.core-async</code>), use the two-parameter engine constructor:</p>
<pre><code class="clojure">(defonce run-engine
  (engine/engine
    claro.runtime.impl.core-async/impl
    {}))
</code></pre>
<p>This will work for any <code>Resolvable</code> returning a core.async channel.</p>
<blockquote>
  <p><strong>Note:</strong> The implementation used by an engine can be accessed using the <a href="claro.engine.html#var-impl">impl</a> function.</p>
</blockquote>
<h3><a href="#environment" name="environment"></a>Environment</h3>
<p>Meaningful data access without configuration pointing at a datasource is rare, so it is necessary for <code>Resolvable</code> values to be aware of said configuration. There are multiple possibilities:</p>
<ul>
  <li>store it in global vars,</li>
  <li>store it in dynamic vars and use <code>binding</code> around the resolution call,</li>
  <li>store it in the <code>Resolvable</code> record.</li>
</ul>
<p>These are viable options for claro, too, but the preferred way would be to bind an engine to your environment, using the <code>:env</code> key:</p>
<pre><code class="clojure">(defonce run-engine
  (engine/engine
    {:env {:db {:subprotocol "postgresql", ...}}}))
</code></pre>
<p>The environment will be passed as the second parameter to both <a href="claro.data.html#var-resolve.21">resolve!</a> and <a href="claro.data.html#var-resolve-batch.21">resolve-batch!</a> and can contain things like datastore connections, a user to scope resolution too, etc …</p>
<p>Parts of the environment can be added or replaced when calling the engine:</p>
<pre><code class="clojure">(run-engine
  (-&gt;Person 1)
  {:env {:db {:subprotocol "mysql", ...}}})
</code></pre>
<h3><a href="#selector" name="selector"></a>Selector</h3>
<p>During each iteration, the resolution engine selects a set of resolvables to process. By default, it attempts to resolve all availble values, but this behaviour can be adjusted by supplying a different <a href="claro.engine.selector.html#var-Selector">Selector</a> when creating the engine:</p>
<pre><code class="clojure">(defonce run-engine
  (engine/engine
    {:selector (claro.data.selector/parallel-selector 2)}))
</code></pre>
<p>Just like <code>:env</code> this can be overridden on a per-call basis, so you are able to use specialized selection for cases where you need it.</p>
<p>See the <a href="claro.engine.selector.html">claro.engine.selector</a> namespace for more variants.</p>
<h3><a href="#middlewares" name="middlewares"></a>Middlewares</h3>
<p>The resolver function can be wrapped with custom middlewares using <a href="claro.engine.html#var-wrap">claro.engine/wrap</a>. It takes two parameters: the environment and the batch of resolvables – all of the same class – and produces a deferred value.</p>
<p>For example, we can write a middleware that attaches a timeout to each single <code>Resolvable</code> batch:</p>
<pre><code class="clojure">(defn wrap-timeout
  [engine timeout-ms]
  (-&gt;&gt; (fn [resolver]
         (fn [env batch]
           (-&gt; (resolver env batch)
               (d/timeout! timeout-ms))))
       (engine/wrap engine)))
</code></pre>
<p>More possibilities include caching, tracing, monitoring, circuit-breaking, etc… I recommend checking out the existing middlewares (in <code>claro.middleware.*</code>) for more examples.</p></div></div></div></body></html>